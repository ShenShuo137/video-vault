# Serverlessæ¶æ„æ”¹é€ æ€»ç»“

> å‰ç«¯å·²æ”¹é€ ä¸ºå®Œå…¨Serverlessæ¶æ„ï¼Œä¸å†ä¾èµ–Flaskåç«¯

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å‰ç«¯ä»£ç æ”¹é€ 

#### æ–°å»ºæ–‡ä»¶ï¼š`frontend/src/api/obs-client.js`
- å°è£…åä¸ºäº‘OBS SDKæ“ä½œ
- å®ç°è§†é¢‘ä¸Šä¼ ã€ä¸‹è½½ã€æŸ¥è¯¢ã€åˆ é™¤ç­‰åŠŸèƒ½
- æ”¯æŒè¿›åº¦å›è°ƒå’Œé”™è¯¯å¤„ç†

#### ä¿®æ”¹æ–‡ä»¶ï¼š`frontend/src/api/video.js`
- ç§»é™¤æ‰€æœ‰Flask APIè°ƒç”¨
- æ”¹ä¸ºç›´æ¥è°ƒç”¨OBSå®¢æˆ·ç«¯
- å®ç°å®Œæ•´çš„Serverless APIæ¥å£

#### æ–°å»ºæ–‡ä»¶ï¼š`frontend/.env.example`
- å‰ç«¯ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
- åŒ…å«åä¸ºäº‘AK/SKã€OBSé…ç½®ç­‰

### 2. äº‘å‡½æ•°æ”¹é€ 

#### ä¿®æ”¹æ–‡ä»¶ï¼š`functions/dlp_scanner_handler.py`
- æ–°å¢ `_save_audit_log_to_obs()` å‡½æ•°
- è‡ªåŠ¨å°†å®¡è®¡æ—¥å¿—ä¿å­˜åˆ°OBS `logs/` ç›®å½•
- å‰ç«¯å¯ç›´æ¥è¯»å–å®¡è®¡æ—¥å¿—JSON

---

## ğŸ“‹ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1: é…ç½®å‰ç«¯ç¯å¢ƒå˜é‡

```bash
cd frontend

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å®é™…é…ç½®
vim .env
```

å¡«å…¥å†…å®¹ï¼š
```bash
VITE_HUAWEI_CLOUD_AK=your_actual_access_key
VITE_HUAWEI_CLOUD_SK=your_actual_secret_key
VITE_OBS_BUCKET_NAME=video-vault-storage
VITE_OBS_ENDPOINT=https://obs.cn-north-4.myhuaweicloud.com
```

### æ­¥éª¤2: é…ç½®OBS CORSè§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰

å‰ç«¯ç›´æ¥æ“ä½œOBSéœ€è¦é…ç½®è·¨åŸŸè§„åˆ™ï¼š

1. ç™»å½•åä¸ºäº‘OBSæ§åˆ¶å°
2. é€‰æ‹©bucket `video-vault-storage`
3. ç‚¹å‡» **åŸºç¡€é…ç½®** â†’ **è·¨åŸŸèµ„æºå…±äº«(CORS)**
4. ç‚¹å‡» **åˆ›å»ºè§„åˆ™**ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```
å…è®¸çš„æ¥æº(AllowedOrigin): *
  ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å…·ä½“åŸŸåï¼Œå¦‚ https://yourdomain.comï¼‰

å…è®¸çš„æ–¹æ³•(AllowedMethod):
  âœ… GET
  âœ… PUT
  âœ… POST
  âœ… DELETE
  âœ… HEAD

å…è®¸çš„å¤´éƒ¨(AllowedHeader): *

æš´éœ²çš„å¤´éƒ¨(ExposeHeader):
  ETag
  x-obs-request-id
  Content-Length

ç¼“å­˜æ—¶é—´(MaxAgeSeconds): 3600
```

5. ç‚¹å‡» **ç¡®å®š** ä¿å­˜

### æ­¥éª¤3: å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨

```bash
cd frontend
npm install  # å¦‚æœè¿˜æ²¡å®‰è£…ä¾èµ–
npm run dev
```

è®¿é—®: `http://localhost:5173`

### æ­¥éª¤4: æµ‹è¯•å®Œæ•´æµç¨‹

1. **ä¸Šä¼ è§†é¢‘**
   - å‰ç«¯ä¸Šä¼  â†’ ç›´æ¥ä¼ åˆ°OBS `uploads/` ç›®å½•
   - OBSè§¦å‘å™¨è‡ªåŠ¨å¯åŠ¨äº‘å‡½æ•°

2. **æŸ¥çœ‹å¤„ç†çŠ¶æ€**
   - å‰ç«¯è½®è¯¢æŸ¥è¯¢OBS `outputs/` ç›®å½•
   - æ£€æµ‹åˆ°æ–‡ä»¶å­˜åœ¨å³å¤„ç†å®Œæˆ

3. **æŸ¥çœ‹å®¡è®¡æ—¥å¿—**
   - å‰ç«¯è¯»å–OBS `logs/{video_id}_audit.json`
   - æ˜¾ç¤ºæ‰€æœ‰æ•æ„Ÿä¿¡æ¯æ£€æµ‹è®°å½•

4. **ä¸‹è½½å¤„ç†åè§†é¢‘**
   - å‰ç«¯ç”ŸæˆOBSä¸´æ—¶ç­¾åURL
   - ç”¨æˆ·ç›´æ¥ä»OBSä¸‹è½½

---

## ğŸ—‘ï¸ å¯ä»¥åˆ é™¤çš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶åœ¨Serverlessæ¶æ„ä¸­**ä¸å†éœ€è¦**ï¼š

```bash
backend/app.py              # Flaskåç«¯ï¼Œå®Œå…¨ä¸éœ€è¦
backend/uploads/            # æœ¬åœ°ä¸Šä¼ ç›®å½•ï¼Œä¸éœ€è¦
backend/*.pyc               # Pythonç¼“å­˜æ–‡ä»¶
```

**Flaskåç«¯å¯ä»¥å®Œå…¨åˆ é™¤ï¼** ğŸ‰

---

## ğŸ†š æ¶æ„å¯¹æ¯”

### âŒ æ—§æ¶æ„ï¼ˆFlaskåç«¯ï¼‰

```
å‰ç«¯ Vue.js
    â†“ HTTP API (http://localhost:5000)
Flaskåç«¯ (éœ€è¦ python app.py)  â† éœ€è¦æ‰‹åŠ¨å¯åŠ¨ï¼
    â†“ è°ƒç”¨æœ¬åœ°Pipeline
VideoVaultPipeline (æœ¬åœ°å¤„ç†)
    â†“
3ä¸ªäº‘å‡½æ•° (éƒ¨ç½²åœ¨åä¸ºäº‘)
```

**é—®é¢˜ï¼š**
- éœ€è¦æ‰‹åŠ¨å¯åŠ¨Flask `python app.py`
- éœ€è¦æœåŠ¡å™¨è¿ç»´
- è§†é¢‘å¤„ç†åœ¨æœ¬åœ°ï¼ˆèµ„æºå—é™ï¼‰

### âœ… æ–°æ¶æ„ï¼ˆå®Œå…¨Serverlessï¼‰

```
å‰ç«¯ Vue.js (OBSé™æ€æ‰˜ç®¡)
    â†“ ç›´æ¥ä¸Šä¼ 
OBSå­˜å‚¨æ¡¶ (uploads/)
    â†“ OBSè§¦å‘å™¨ï¼ˆè‡ªåŠ¨ï¼‰
3ä¸ªäº‘å‡½æ•° (è‡ªåŠ¨å¹¶è¡Œå¤„ç†)
    â†“ è‡ªåŠ¨è¾“å‡º
OBSå­˜å‚¨æ¡¶ (outputs/, logs/)
    â†‘ å‰ç«¯ç›´æ¥æŸ¥è¯¢
å‰ç«¯ (è½®è¯¢/è¯»å–)
```

**ä¼˜åŠ¿ï¼š**
- âœ… 0è¿ç»´ï¼šæ— éœ€å¯åŠ¨ä»»ä½•æœåŠ¡å™¨
- âœ… è‡ªåŠ¨æ‰©å®¹ï¼šå¹¶å‘å¤„ç†èƒ½åŠ›æ— ä¸Šé™
- âœ… æŒ‰éœ€ä»˜è´¹ï¼šåªä¸ºå®é™…ä½¿ç”¨ä»˜è´¹
- âœ… é«˜å¯ç”¨ï¼šåä¸ºäº‘ä¿éšœ99.95%å¯ç”¨æ€§

---

## ğŸ’° æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | Flaskåç«¯ | Serverless |
|------|-----------|------------|
| äº‘æœåŠ¡å™¨ | Â¥200/æœˆ | Â¥0 âœ… |
| å¸¦å®½ | Â¥50/æœˆ | Â¥0 âœ… |
| OBSå­˜å‚¨ | - | Â¥9.9/æœˆ |
| OBSæµé‡ | - | Â¥25/æœˆ |
| äº‘å‡½æ•° | - | Â¥12.43/æœˆ |
| OCR | - | Â¥1/æœˆ |
| **æ€»è®¡** | **Â¥250+/æœˆ** | **Â¥48.33/æœˆ** |

**èŠ‚çœçº¦80%æˆæœ¬ï¼** ğŸŠ

---

## ğŸ“± å‰ç«¯åŠŸèƒ½è¯´æ˜

### ä¸Šä¼ åŠŸèƒ½
```javascript
// ä¸Šä¼ è§†é¢‘ç¤ºä¾‹
const result = await videoAPI.uploadVideo(file, (percent) => {
  console.log(`ä¸Šä¼ è¿›åº¦: ${percent}%`)
})

// è¿”å›
// { success: true, video_id: "12345", message: "..." }
```

### æŸ¥è¯¢çŠ¶æ€
```javascript
// è½®è¯¢æŸ¥è¯¢å¤„ç†çŠ¶æ€
const status = await videoAPI.getVideoStatus(videoId)

// è¿”å›
// { status: "processing" | "completed" | "error", exists: true/false }
```

### è·å–å®¡è®¡æ—¥å¿—
```javascript
// è·å–å•ä¸ªè§†é¢‘çš„å®¡è®¡æ—¥å¿—
const { logs, total } = await videoAPI.getAuditLogs({ video_id: videoId })

// è·å–æ‰€æœ‰å®¡è®¡æ—¥å¿—
const { logs, total } = await videoAPI.getAuditLogs()
```

### ä¸‹è½½è§†é¢‘
```javascript
// è·å–ä¸‹è½½URLï¼ˆä¸´æ—¶ç­¾åURLï¼Œ1å°æ—¶æœ‰æ•ˆï¼‰
const downloadUrl = await videoAPI.downloadVideo(videoId)

// ç”¨æˆ·ç‚¹å‡»ä¸‹è½½
window.open(downloadUrl, '_blank')
```

---

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### éƒ¨ç½²å‰ç«¯åˆ°OBSé™æ€æ‰˜ç®¡

```bash
# 1. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
cd frontend
npm run build

# 2. ä¸Šä¼ åˆ°OBS
# æ–¹å¼A: ä½¿ç”¨åä¸ºäº‘OBSæ§åˆ¶å°æ‰‹åŠ¨ä¸Šä¼ distç›®å½•
# æ–¹å¼B: ä½¿ç”¨obsutilå‘½ä»¤è¡Œå·¥å…·

# é…ç½®OBSé™æ€ç½‘ç«™æ‰˜ç®¡
# OBSæ§åˆ¶å° â†’ bucket â†’ é™æ€ç½‘ç«™æ‰˜ç®¡
# - é»˜è®¤é¦–é¡µ: index.html
# - 404é”™è¯¯é¡µé¢: index.htmlï¼ˆæ”¯æŒVue Routerï¼‰
```

è®¿é—®åŸŸåç¤ºä¾‹ï¼š
```
http://video-vault-storage.obs-website.cn-north-4.myhuaweicloud.com
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®‰å…¨æ€§
- **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼šä¸è¦å°†AK/SKç›´æ¥å†™åœ¨å‰ç«¯ä»£ç 
- **æ¨èæ–¹æ¡ˆ**ï¼šä½¿ç”¨ä¸´æ—¶è®¿é—®å‡­è¯ï¼ˆSTSï¼‰æˆ–åç«¯API Gatewayä»£ç†

### 2. CORSé…ç½®
- å¿…é¡»é…ç½®OBS CORSè§„åˆ™ï¼Œå¦åˆ™å‰ç«¯æ— æ³•è®¿é—®
- ç”Ÿäº§ç¯å¢ƒå»ºè®®é™åˆ¶AllowedOriginä¸ºå…·ä½“åŸŸå

### 3. OBSè´¹ç”¨
- å­˜å‚¨è´¹ç”¨ï¼šæŒ‰å®é™…å­˜å‚¨é‡è®¡è´¹
- æµé‡è´¹ç”¨ï¼šæŒ‰ä¸‹è½½æµé‡è®¡è´¹
- è¯·æ±‚è´¹ç”¨ï¼šGET/PUTè¯·æ±‚æ¬¡æ•°è®¡è´¹

### 4. è½®è¯¢ä¼˜åŒ–
- å»ºè®®ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•å‡å°‘è½®è¯¢é¢‘ç‡
- å¯ä»¥å®ç°WebSocketæˆ–Server-Sent Eventså®æ—¶æ¨é€

---

## ğŸ‰ æ€»ç»“

å®Œå…¨Serverlessæ¶æ„æ”¹é€ å®Œæˆï¼

**ç°åœ¨ä½ å¯ä»¥ï¼š**
- âœ… åˆ é™¤Flask `backend/app.py`
- âœ… ä¸éœ€è¦å¯åŠ¨ä»»ä½•åç«¯æœåŠ¡
- âœ… å‰ç«¯ç›´æ¥æ“ä½œOBS
- âœ… äº‘å‡½æ•°è‡ªåŠ¨è§¦å‘å¤„ç†
- âœ… èŠ‚çœ80%æˆæœ¬

**Flaskåç«¯å·²ç»æˆä¸ºå†å²ï¼** ğŸŠ
