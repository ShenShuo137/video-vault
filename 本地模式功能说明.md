# Video Vault 本地模式功能说明

## 📋 已实现的功能

### 1. 仪表盘数据显示 ✅

**功能说明：**
- 在本地模式下，从文件系统读取处理数据
- 统计已处理视频数量
- 统计检测到的敏感信息总数
- 显示高风险视频数量（敏感信息≥5个）
- 显示最近的检测活动

**数据来源：**
```
backend/uploads/output/
├── {video_id}/
│   └── audit_log.json          # 审计日志文件
└── {video_id}_sanitized.mp4    # 处理后的视频
```

**API接口：** `GET /api/stats/dashboard`

### 2. 审计日志页面 ✅

**功能说明：**
- 显示所有视频的敏感信息检测记录
- 支持按视频ID筛选
- 显示检测的敏感类型、文本内容、置信度等
- 按时间倒序排列

**数据结构：**
```json
{
  "video_id": "uuid",
  "video_title": "test_video.mp4",
  "total_detections": 10,
  "detections": [
    {
      "slice_index": 0,
      "frame_id": 0,
      "timestamp": "0.00",
      "type": "openai_key",
      "text": "sk-abc123...",
      "confidence": 0.95,
      "bbox": {"x": 100, "y": 200, "width": 300, "height": 50}
    }
  ],
  "processed_at": "2024-01-20T10:30:00"
}
```

**API接口：** `GET /api/audit/logs?video_id={id}`

### 3. 清空数据功能 ✅

**功能说明：**
- 在视频列表页面提供"清空数据"按钮
- 使用确认对话框防止误操作
- 清空所有上传的原始视频和处理结果
- 仅在本地模式下可用

**清空范围：**
- 删除 `backend/uploads/output/` 目录下的所有文件
- 删除 `backend/uploads/` 下的原始视频文件
- 保留目录结构，方便下次使用

**API接口：** `POST /api/data/clear`

**使用方法：**
1. 进入"视频列表"页面
2. 点击右上角的"清空数据"按钮
3. 在弹出的确认对话框中点击"确定"
4. 等待清空完成，页面会自动刷新

---

## 🔧 AI助手配置

### ChatAnywhere API配置

**配置文件：** `.env`

```env
# AI大模型API配置 (ChatAnywhere)
LLM_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  # 你的API Key
LLM_API_BASE=https://api.chatanywhere.tech/v1             # API地址
LLM_MODEL=gpt-3.5-turbo                                   # 模型名称
```

**常见API服务商：**
| 服务商 | API Base URL |
|--------|-------------|
| ChatAnywhere | `https://api.chatanywhere.tech/v1` |
| API2D | `https://openai.api2d.net/v1` |
| OpenAI-SB | `https://api.openai-sb.com/v1` |
| OpenAI官方 | `https://api.openai.com/v1` |

**配置完成后：**
1. 重启后端：`python backend/app.py`
2. 检查启动日志，确认 `AI Agent: 可用`
3. 在Web界面点击"AI助手"开始使用

**详细说明：** 参见 `AI_ASSISTANT_SETUP.md`

---

## 🎯 使用流程

### 完整的视频处理流程

1. **上传视频**
   - 进入"上传视频"页面
   - 拖拽或选择视频文件
   - 等待处理完成

2. **查看处理结果**
   - 进入"仪表盘"查看统计信息
   - 进入"视频列表"下载处理后的视频
   - 进入"审计日志"查看详细的检测记录

3. **AI助手分析**
   - 进入"AI助手"页面
   - 输入问题，例如：
     - "有哪些高风险视频？"
     - "最近发现了哪些敏感信息？"
     - "生成一份安全报告"

4. **清空数据**
   - 下载所需的视频后
   - 进入"视频列表"
   - 点击"清空数据"按钮
   - 确认清空

---

## 📊 数据流转示意图

```
┌─────────────────┐
│   用户上传视频   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  视频切片处理    │  (video_slicer)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  DLP扫描脱敏     │  (dlp_scanner)
│  - OCR识别      │
│  - 敏感信息检测  │
│  - 区域模糊      │
└────────┬────────┘
         │
         ├──────────────────┐
         │                  │
         ▼                  ▼
┌─────────────────┐  ┌─────────────────┐
│  视频合并        │  │  保存审计日志    │
│  (video_merger) │  │  audit_log.json │
└────────┬────────┘  └─────────────────┘
         │
         ▼
┌─────────────────┐
│  输出脱敏视频    │
│  xxx_sanitized  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  用户下载/查看   │
└─────────────────┘
```

---

## 🐛 故障排查

### 问题1：仪表盘显示空数据

**可能原因：**
- 还没有处理过任何视频
- 审计日志文件不存在

**解决方法：**
1. 先上传并处理一个视频
2. 检查 `backend/uploads/output/` 目录是否有文件
3. 检查每个video_id子目录下是否有 `audit_log.json`

### 问题2：审计日志页面空白

**可能原因：**
- 同上，没有审计日志文件

**解决方法：**
1. 处理视频时确保pipeline保存了审计日志
2. 检查后端控制台是否有错误信息
3. 手动检查 audit_log.json 文件内容是否正确

### 问题3：清空数据失败

**可能原因：**
- 文件被其他程序占用
- 权限不足

**解决方法：**
1. 关闭所有视频播放器
2. 重启后端服务
3. 以管理员权限运行

### 问题4：AI助手不可用

**可能原因：**
- 没有配置 LLM_API_KEY
- API地址错误
- openai库未安装

**解决方法：**
1. 检查 .env 文件中的配置
2. 安装依赖：`pip install openai`
3. 重启后端服务
4. 查看详细文档：`AI_ASSISTANT_SETUP.md`

---

## 💡 最佳实践

### 1. 本地开发建议

**推荐配置：**
```env
LOCAL_MODE=true          # 使用本地Tesseract和FFmpeg
SLICE_DURATION=60        # 切片时长60秒
OCR_CONFIDENCE_THRESHOLD=0.6  # OCR置信度阈值
BLUR_INTENSITY=51        # 模糊强度
```

### 2. 视频处理建议

- **开发测试**：使用短视频（10-30秒），快速验证功能
- **演示**：使用包含明显敏感信息的测试视频
- **生产**：根据实际需求调整切片时长和OCR阈值

### 3. 数据管理建议

- 定期清空测试数据，避免占用过多磁盘空间
- 重要视频处理后及时下载保存
- 本地模式不使用数据库，数据全部存在文件系统

### 4. AI助手使用建议

- 使用明确的问题，如"列出高风险视频"而不是"看看有什么问题"
- 生成报告前确保已经处理过视频
- gpt-3.5-turbo 性价比高，适合日常使用
- gpt-4 效果更好，适合重要演示

---

## 🚀 下一步

1. ✅ 配置AI助手（ChatAnywhere API）
2. ✅ 测试完整的视频处理流程
3. ✅ 验证仪表盘和审计日志功能
4. ✅ 测试清空数据功能
5. ⏳ 配置华为云服务（OCR + MPC）
6. ⏳ 部署到FunctionGraph

**文档参考：**
- `CLOUD_NATIVE_ARCHITECTURE.md` - 云原生架构说明
- `HUAWEI_CLOUD_SETUP.md` - 华为云配置指南
- `HUAWEI_LAYER_GUIDE.md` - 依赖层与MPC对比
- `AI_ASSISTANT_SETUP.md` - AI助手配置指南

---

**祝使用愉快！** 🎉
